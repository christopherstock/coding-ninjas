'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _helpers = require('../../formatter/helpers');

var _command_types = require('./command_types');

var _command_types2 = _interopRequireDefault(_command_types);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _readline = require('readline');

var _readline2 = _interopRequireDefault(_readline);

var _stack_trace_filter = require('../stack_trace_filter');

var _stack_trace_filter2 = _interopRequireDefault(_stack_trace_filter);

var _support_code_library_builder = require('../../support_code_library_builder');

var _support_code_library_builder2 = _interopRequireDefault(_support_code_library_builder);

var _test_case_runner = require('../test_case_runner');

var _test_case_runner2 = _interopRequireDefault(_test_case_runner);

var _user_code_runner = require('../../user_code_runner');

var _user_code_runner2 = _interopRequireDefault(_user_code_runner);

var _verror = require('verror');

var _verror2 = _interopRequireDefault(_verror);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var EVENTS = ['test-case-prepared', 'test-case-started', 'test-step-started', 'test-step-attachment', 'test-step-finished', 'test-case-finished'];

var Slave = function () {
  function Slave(_ref) {
    var _this = this;

    var cwd = _ref.cwd,
        stdin = _ref.stdin,
        stdout = _ref.stdout;
    (0, _classCallCheck3.default)(this, Slave);

    this.initialized = false;
    this.stdin = stdin;
    this.stdout = stdout;
    this.cwd = cwd;
    this.eventBroadcaster = new _events2.default();
    this.stackTraceFilter = new _stack_trace_filter2.default();
    EVENTS.forEach(function (name) {
      _this.eventBroadcaster.on(name, function (data) {
        return _this.stdout.write(JSON.stringify({ command: _command_types2.default.EVENT, name: name, data: data }) + '\n');
      });
    });
  }

  (0, _createClass3.default)(Slave, [{
    key: 'initialize',
    value: function () {
      var _ref3 = (0, _bluebird.coroutine)(function* (_ref2) {
        var filterStacktraces = _ref2.filterStacktraces,
            supportCodeRequiredModules = _ref2.supportCodeRequiredModules,
            supportCodePaths = _ref2.supportCodePaths,
            worldParameters = _ref2.worldParameters;

        supportCodeRequiredModules.map(function (module) {
          return require(module);
        });
        _support_code_library_builder2.default.reset(this.cwd);
        supportCodePaths.forEach(function (codePath) {
          return require(codePath);
        });
        this.supportCodeLibrary = _support_code_library_builder2.default.finalize();
        this.worldParameters = worldParameters;
        this.filterStacktraces = filterStacktraces;
        if (this.filterStacktraces) {
          this.stackTraceFilter.filter();
        }
        yield this.runTestRunHooks('beforeTestRunHookDefinitions', 'a BeforeAll');
        this.stdout.write(JSON.stringify({ command: _command_types2.default.READY }) + '\n');
      });

      function initialize(_x) {
        return _ref3.apply(this, arguments);
      }

      return initialize;
    }()
  }, {
    key: 'finalize',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* () {
        yield this.runTestRunHooks('afterTestRunHookDefinitions', 'an AfterAll');
        if (this.filterStacktraces) {
          this.stackTraceFilter.unfilter();
        }
        process.exit();
      });

      function finalize() {
        return _ref4.apply(this, arguments);
      }

      return finalize;
    }()
  }, {
    key: 'parseMasterLine',
    value: function parseMasterLine(line) {
      var input = JSON.parse(line);
      if (input.command === 'initialize') {
        this.initialize(input);
      } else if (input.command === 'finalize') {
        this.finalize();
      } else if (input.command === 'run') {
        this.runTestCase(input);
      }
    }
  }, {
    key: 'run',
    value: function () {
      var _ref5 = (0, _bluebird.coroutine)(function* () {
        var _this2 = this;

        this.rl = _readline2.default.createInterface({ input: this.stdin });
        this.rl.on('line', function (line) {
          _this2.parseMasterLine(line);
        });
      });

      function run() {
        return _ref5.apply(this, arguments);
      }

      return run;
    }()
  }, {
    key: 'runTestCase',
    value: function () {
      var _ref7 = (0, _bluebird.coroutine)(function* (_ref6) {
        var testCase = _ref6.testCase,
            skip = _ref6.skip;

        var testCaseRunner = new _test_case_runner2.default({
          eventBroadcaster: this.eventBroadcaster,
          skip: skip,
          supportCodeLibrary: this.supportCodeLibrary,
          testCase: testCase,
          worldParameters: this.worldParameters
        });
        yield testCaseRunner.run();
        this.stdout.write(JSON.stringify({ command: _command_types2.default.READY }) + '\n');
      });

      function runTestCase(_x2) {
        return _ref7.apply(this, arguments);
      }

      return runTestCase;
    }()
  }, {
    key: 'runTestRunHooks',
    value: function () {
      var _ref8 = (0, _bluebird.coroutine)(function* (key, name) {
        var _this3 = this;

        yield _bluebird2.default.each(this.supportCodeLibrary[key], function () {
          var _ref9 = (0, _bluebird.coroutine)(function* (hookDefinition) {
            var _ref10 = yield _user_code_runner2.default.run({
              argsArray: [],
              fn: hookDefinition.code,
              thisArg: null,
              timeoutInMilliseconds: hookDefinition.options.timeout || _this3.supportCodeLibrary.defaultTimeout
            }),
                error = _ref10.error;

            if (error) {
              var location = (0, _helpers.formatLocation)(hookDefinition);
              throw new _verror2.default(error, name + ' hook errored, process exiting: ' + location);
            }
          });

          return function (_x5) {
            return _ref9.apply(this, arguments);
          };
        }());
      });

      function runTestRunHooks(_x3, _x4) {
        return _ref8.apply(this, arguments);
      }

      return runTestRunHooks;
    }()
  }]);
  return Slave;
}();

exports.default = Slave;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9ydW50aW1lL3BhcmFsbGVsL3NsYXZlLmpzIl0sIm5hbWVzIjpbIkVWRU5UUyIsIlNsYXZlIiwiY3dkIiwic3RkaW4iLCJzdGRvdXQiLCJpbml0aWFsaXplZCIsImV2ZW50QnJvYWRjYXN0ZXIiLCJzdGFja1RyYWNlRmlsdGVyIiwiZm9yRWFjaCIsIm9uIiwibmFtZSIsIndyaXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsImNvbW1hbmQiLCJFVkVOVCIsImRhdGEiLCJmaWx0ZXJTdGFja3RyYWNlcyIsInN1cHBvcnRDb2RlUmVxdWlyZWRNb2R1bGVzIiwic3VwcG9ydENvZGVQYXRocyIsIndvcmxkUGFyYW1ldGVycyIsIm1hcCIsInJlcXVpcmUiLCJtb2R1bGUiLCJyZXNldCIsImNvZGVQYXRoIiwic3VwcG9ydENvZGVMaWJyYXJ5IiwiZmluYWxpemUiLCJmaWx0ZXIiLCJydW5UZXN0UnVuSG9va3MiLCJSRUFEWSIsInVuZmlsdGVyIiwicHJvY2VzcyIsImV4aXQiLCJsaW5lIiwiaW5wdXQiLCJwYXJzZSIsImluaXRpYWxpemUiLCJydW5UZXN0Q2FzZSIsInJsIiwiY3JlYXRlSW50ZXJmYWNlIiwicGFyc2VNYXN0ZXJMaW5lIiwidGVzdENhc2UiLCJza2lwIiwidGVzdENhc2VSdW5uZXIiLCJydW4iLCJrZXkiLCJlYWNoIiwiaG9va0RlZmluaXRpb24iLCJhcmdzQXJyYXkiLCJmbiIsImNvZGUiLCJ0aGlzQXJnIiwidGltZW91dEluTWlsbGlzZWNvbmRzIiwib3B0aW9ucyIsInRpbWVvdXQiLCJkZWZhdWx0VGltZW91dCIsImVycm9yIiwibG9jYXRpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLElBQU1BLFNBQVMsQ0FDYixvQkFEYSxFQUViLG1CQUZhLEVBR2IsbUJBSGEsRUFJYixz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LEsiLCJmaWxlIjoic2xhdmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmb3JtYXRMb2NhdGlvbiB9IGZyb20gJy4uLy4uL2Zvcm1hdHRlci9oZWxwZXJzJ1xuaW1wb3J0IGNvbW1hbmRUeXBlcyBmcm9tICcuL2NvbW1hbmRfdHlwZXMnXG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cydcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJ1xuaW1wb3J0IFN0YWNrVHJhY2VGaWx0ZXIgZnJvbSAnLi4vc3RhY2tfdHJhY2VfZmlsdGVyJ1xuaW1wb3J0IHN1cHBvcnRDb2RlTGlicmFyeUJ1aWxkZXIgZnJvbSAnLi4vLi4vc3VwcG9ydF9jb2RlX2xpYnJhcnlfYnVpbGRlcidcbmltcG9ydCBUZXN0Q2FzZVJ1bm5lciBmcm9tICcuLi90ZXN0X2Nhc2VfcnVubmVyJ1xuaW1wb3J0IFVzZXJDb2RlUnVubmVyIGZyb20gJy4uLy4uL3VzZXJfY29kZV9ydW5uZXInXG5pbXBvcnQgVkVycm9yIGZyb20gJ3ZlcnJvcidcblxuY29uc3QgRVZFTlRTID0gW1xuICAndGVzdC1jYXNlLXByZXBhcmVkJyxcbiAgJ3Rlc3QtY2FzZS1zdGFydGVkJyxcbiAgJ3Rlc3Qtc3RlcC1zdGFydGVkJyxcbiAgJ3Rlc3Qtc3RlcC1hdHRhY2htZW50JyxcbiAgJ3Rlc3Qtc3RlcC1maW5pc2hlZCcsXG4gICd0ZXN0LWNhc2UtZmluaXNoZWQnXG5dXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNsYXZlIHtcbiAgY29uc3RydWN0b3IoeyBjd2QsIHN0ZGluLCBzdGRvdXQgfSkge1xuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZVxuICAgIHRoaXMuc3RkaW4gPSBzdGRpblxuICAgIHRoaXMuc3Rkb3V0ID0gc3Rkb3V0XG4gICAgdGhpcy5jd2QgPSBjd2RcbiAgICB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgICB0aGlzLnN0YWNrVHJhY2VGaWx0ZXIgPSBuZXcgU3RhY2tUcmFjZUZpbHRlcigpXG4gICAgRVZFTlRTLmZvckVhY2gobmFtZSA9PiB7XG4gICAgICB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIub24obmFtZSwgZGF0YSA9PlxuICAgICAgICB0aGlzLnN0ZG91dC53cml0ZShcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7IGNvbW1hbmQ6IGNvbW1hbmRUeXBlcy5FVkVOVCwgbmFtZSwgZGF0YSB9KSArICdcXG4nXG4gICAgICAgIClcbiAgICAgIClcbiAgICB9KVxuICB9XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSh7XG4gICAgZmlsdGVyU3RhY2t0cmFjZXMsXG4gICAgc3VwcG9ydENvZGVSZXF1aXJlZE1vZHVsZXMsXG4gICAgc3VwcG9ydENvZGVQYXRocyxcbiAgICB3b3JsZFBhcmFtZXRlcnNcbiAgfSkge1xuICAgIHN1cHBvcnRDb2RlUmVxdWlyZWRNb2R1bGVzLm1hcChtb2R1bGUgPT4gcmVxdWlyZShtb2R1bGUpKVxuICAgIHN1cHBvcnRDb2RlTGlicmFyeUJ1aWxkZXIucmVzZXQodGhpcy5jd2QpXG4gICAgc3VwcG9ydENvZGVQYXRocy5mb3JFYWNoKGNvZGVQYXRoID0+IHJlcXVpcmUoY29kZVBhdGgpKVxuICAgIHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5ID0gc3VwcG9ydENvZGVMaWJyYXJ5QnVpbGRlci5maW5hbGl6ZSgpXG4gICAgdGhpcy53b3JsZFBhcmFtZXRlcnMgPSB3b3JsZFBhcmFtZXRlcnNcbiAgICB0aGlzLmZpbHRlclN0YWNrdHJhY2VzID0gZmlsdGVyU3RhY2t0cmFjZXNcbiAgICBpZiAodGhpcy5maWx0ZXJTdGFja3RyYWNlcykge1xuICAgICAgdGhpcy5zdGFja1RyYWNlRmlsdGVyLmZpbHRlcigpXG4gICAgfVxuICAgIGF3YWl0IHRoaXMucnVuVGVzdFJ1bkhvb2tzKCdiZWZvcmVUZXN0UnVuSG9va0RlZmluaXRpb25zJywgJ2EgQmVmb3JlQWxsJylcbiAgICB0aGlzLnN0ZG91dC53cml0ZShKU09OLnN0cmluZ2lmeSh7IGNvbW1hbmQ6IGNvbW1hbmRUeXBlcy5SRUFEWSB9KSArICdcXG4nKVxuICB9XG5cbiAgYXN5bmMgZmluYWxpemUoKSB7XG4gICAgYXdhaXQgdGhpcy5ydW5UZXN0UnVuSG9va3MoJ2FmdGVyVGVzdFJ1bkhvb2tEZWZpbml0aW9ucycsICdhbiBBZnRlckFsbCcpXG4gICAgaWYgKHRoaXMuZmlsdGVyU3RhY2t0cmFjZXMpIHtcbiAgICAgIHRoaXMuc3RhY2tUcmFjZUZpbHRlci51bmZpbHRlcigpXG4gICAgfVxuICAgIHByb2Nlc3MuZXhpdCgpXG4gIH1cblxuICBwYXJzZU1hc3RlckxpbmUobGluZSkge1xuICAgIGNvbnN0IGlucHV0ID0gSlNPTi5wYXJzZShsaW5lKVxuICAgIGlmIChpbnB1dC5jb21tYW5kID09PSAnaW5pdGlhbGl6ZScpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZShpbnB1dClcbiAgICB9IGVsc2UgaWYgKGlucHV0LmNvbW1hbmQgPT09ICdmaW5hbGl6ZScpIHtcbiAgICAgIHRoaXMuZmluYWxpemUoKVxuICAgIH0gZWxzZSBpZiAoaW5wdXQuY29tbWFuZCA9PT0gJ3J1bicpIHtcbiAgICAgIHRoaXMucnVuVGVzdENhc2UoaW5wdXQpXG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcnVuKCkge1xuICAgIHRoaXMucmwgPSByZWFkbGluZS5jcmVhdGVJbnRlcmZhY2UoeyBpbnB1dDogdGhpcy5zdGRpbiB9KVxuICAgIHRoaXMucmwub24oJ2xpbmUnLCBsaW5lID0+IHtcbiAgICAgIHRoaXMucGFyc2VNYXN0ZXJMaW5lKGxpbmUpXG4gICAgfSlcbiAgfVxuXG4gIGFzeW5jIHJ1blRlc3RDYXNlKHsgdGVzdENhc2UsIHNraXAgfSkge1xuICAgIGNvbnN0IHRlc3RDYXNlUnVubmVyID0gbmV3IFRlc3RDYXNlUnVubmVyKHtcbiAgICAgIGV2ZW50QnJvYWRjYXN0ZXI6IHRoaXMuZXZlbnRCcm9hZGNhc3RlcixcbiAgICAgIHNraXAsXG4gICAgICBzdXBwb3J0Q29kZUxpYnJhcnk6IHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5LFxuICAgICAgdGVzdENhc2UsXG4gICAgICB3b3JsZFBhcmFtZXRlcnM6IHRoaXMud29ybGRQYXJhbWV0ZXJzXG4gICAgfSlcbiAgICBhd2FpdCB0ZXN0Q2FzZVJ1bm5lci5ydW4oKVxuICAgIHRoaXMuc3Rkb3V0LndyaXRlKEpTT04uc3RyaW5naWZ5KHsgY29tbWFuZDogY29tbWFuZFR5cGVzLlJFQURZIH0pICsgJ1xcbicpXG4gIH1cblxuICBhc3luYyBydW5UZXN0UnVuSG9va3Moa2V5LCBuYW1lKSB7XG4gICAgYXdhaXQgUHJvbWlzZS5lYWNoKHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5W2tleV0sIGFzeW5jIGhvb2tEZWZpbml0aW9uID0+IHtcbiAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IFVzZXJDb2RlUnVubmVyLnJ1bih7XG4gICAgICAgIGFyZ3NBcnJheTogW10sXG4gICAgICAgIGZuOiBob29rRGVmaW5pdGlvbi5jb2RlLFxuICAgICAgICB0aGlzQXJnOiBudWxsLFxuICAgICAgICB0aW1lb3V0SW5NaWxsaXNlY29uZHM6XG4gICAgICAgICAgaG9va0RlZmluaXRpb24ub3B0aW9ucy50aW1lb3V0IHx8XG4gICAgICAgICAgdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkuZGVmYXVsdFRpbWVvdXRcbiAgICAgIH0pXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgY29uc3QgbG9jYXRpb24gPSBmb3JtYXRMb2NhdGlvbihob29rRGVmaW5pdGlvbilcbiAgICAgICAgdGhyb3cgbmV3IFZFcnJvcihcbiAgICAgICAgICBlcnJvcixcbiAgICAgICAgICBgJHtuYW1lfSBob29rIGVycm9yZWQsIHByb2Nlc3MgZXhpdGluZzogJHtsb2NhdGlvbn1gXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG4iXX0=