'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _argv_parser = require('./argv_parser');

var _argv_parser2 = _interopRequireDefault(_argv_parser);

var _fs = require('mz/fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _option_splitter = require('./option_splitter');

var _option_splitter2 = _interopRequireDefault(_option_splitter);

var _glob = require('glob');

var _glob2 = _interopRequireDefault(_glob);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var globP = (0, _bluebird.promisify)(_glob2.default);

var ConfigurationBuilder = function () {
  (0, _createClass3.default)(ConfigurationBuilder, null, [{
    key: 'build',
    value: function () {
      var _ref = (0, _bluebird.coroutine)(function* (options) {
        var builder = new ConfigurationBuilder(options);
        return yield builder.build();
      });

      function build(_x) {
        return _ref.apply(this, arguments);
      }

      return build;
    }()
  }]);

  function ConfigurationBuilder(_ref2) {
    var argv = _ref2.argv,
        cwd = _ref2.cwd;
    (0, _classCallCheck3.default)(this, ConfigurationBuilder);

    this.cwd = cwd;

    var parsedArgv = _argv_parser2.default.parse(argv);
    this.args = parsedArgv.args;
    this.options = parsedArgv.options;
  }

  (0, _createClass3.default)(ConfigurationBuilder, [{
    key: 'build',
    value: function () {
      var _ref3 = (0, _bluebird.coroutine)(function* () {
        var listI18nKeywordsFor = this.options.i18nKeywords;
        var listI18nLanguages = !!this.options.i18nLanguages;
        var unexpandedFeaturePaths = yield this.getUnexpandedFeaturePaths();
        var featurePaths = [];
        var supportCodePaths = [];
        if (!listI18nKeywordsFor && !listI18nLanguages) {
          featurePaths = yield this.expandFeaturePaths(unexpandedFeaturePaths);
          var unexpandedSupportCodePaths = this.options.require;
          if (unexpandedSupportCodePaths.length === 0) {
            unexpandedSupportCodePaths = this.getFeatureDirectoryPaths(featurePaths);
          }
          supportCodePaths = yield this.expandPaths(unexpandedSupportCodePaths, '.js');
        }
        return {
          featureDefaultLanguage: this.options.language,
          featurePaths: featurePaths,
          formats: this.getFormats(),
          formatOptions: this.getFormatOptions(),
          listI18nKeywordsFor: listI18nKeywordsFor,
          listI18nLanguages: listI18nLanguages,
          parallel: this.options.parallel,
          profiles: this.options.profile,
          pickleFilterOptions: {
            featurePaths: unexpandedFeaturePaths,
            names: this.options.name,
            tagExpression: this.options.tags
          },
          runtimeOptions: {
            dryRun: !!this.options.dryRun,
            failFast: !!this.options.failFast,
            filterStacktraces: !this.options.backtrace,
            strict: !!this.options.strict,
            worldParameters: this.options.worldParameters
          },
          shouldExitImmediately: !!this.options.exit,
          supportCodePaths: supportCodePaths,
          supportCodeRequiredModules: this.options.requireModule
        };
      });

      function build() {
        return _ref3.apply(this, arguments);
      }

      return build;
    }()
  }, {
    key: 'expandPaths',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* (unexpandedPaths, defaultExtension) {
        var _this = this;

        var expandedPaths = yield _bluebird2.default.map(unexpandedPaths, function () {
          var _ref5 = (0, _bluebird.coroutine)(function* (unexpandedPath) {
            var matches = yield globP(unexpandedPath, {
              absolute: true,
              cwd: _this.cwd
            });
            return yield _bluebird2.default.map(matches, function () {
              var _ref6 = (0, _bluebird.coroutine)(function* (match) {
                if (_path2.default.extname(match) === '') {
                  return yield globP(match + '/**/*' + defaultExtension);
                }
                return match;
              });

              return function (_x5) {
                return _ref6.apply(this, arguments);
              };
            }());
          });

          return function (_x4) {
            return _ref5.apply(this, arguments);
          };
        }());
        return _lodash2.default.flattenDepth(expandedPaths, 2).map(function (x) {
          return _path2.default.normalize(x);
        });
      });

      function expandPaths(_x2, _x3) {
        return _ref4.apply(this, arguments);
      }

      return expandPaths;
    }()
  }, {
    key: 'expandFeaturePaths',
    value: function () {
      var _ref7 = (0, _bluebird.coroutine)(function* (featurePaths) {
        featurePaths = featurePaths.map(function (p) {
          return p.replace(/(:\d+)*$/g, '');
        }); // Strip line numbers
        return yield this.expandPaths(featurePaths, '.feature');
      });

      function expandFeaturePaths(_x6) {
        return _ref7.apply(this, arguments);
      }

      return expandFeaturePaths;
    }()
  }, {
    key: 'getFeatureDirectoryPaths',
    value: function getFeatureDirectoryPaths(featurePaths) {
      var _this2 = this;

      var featureDirs = featurePaths.map(function (featurePath) {
        var featureDir = _path2.default.dirname(featurePath);
        var childDir = void 0;
        var parentDir = featureDir;
        while (childDir !== parentDir) {
          childDir = parentDir;
          parentDir = _path2.default.dirname(childDir);
          if (_path2.default.basename(parentDir) === 'features') {
            featureDir = parentDir;
            break;
          }
        }
        return _path2.default.relative(_this2.cwd, featureDir);
      });
      return _lodash2.default.uniq(featureDirs);
    }
  }, {
    key: 'getFormatOptions',
    value: function getFormatOptions() {
      var formatOptions = _lodash2.default.clone(this.options.formatOptions);
      formatOptions.cwd = this.cwd;
      _lodash2.default.defaults(formatOptions, { colorsEnabled: true });
      return formatOptions;
    }
  }, {
    key: 'getFormats',
    value: function getFormats() {
      var mapping = { '': 'progress' };
      this.options.format.forEach(function (format) {
        var _OptionSplitter$split = _option_splitter2.default.split(format),
            _OptionSplitter$split2 = (0, _slicedToArray3.default)(_OptionSplitter$split, 2),
            type = _OptionSplitter$split2[0],
            outputTo = _OptionSplitter$split2[1];

        mapping[outputTo || ''] = type;
      });
      return _lodash2.default.map(mapping, function (type, outputTo) {
        return { outputTo: outputTo, type: type };
      });
    }
  }, {
    key: 'getUnexpandedFeaturePaths',
    value: function () {
      var _ref8 = (0, _bluebird.coroutine)(function* () {
        var _this3 = this;

        if (this.args.length > 0) {
          var nestedFeaturePaths = yield _bluebird2.default.map(this.args, function () {
            var _ref9 = (0, _bluebird.coroutine)(function* (arg) {
              var filename = _path2.default.basename(arg);
              if (filename[0] === '@') {
                var filePath = _path2.default.join(_this3.cwd, arg);
                var content = yield _fs2.default.readFile(filePath, 'utf8');
                return _lodash2.default.chain(content).split('\n').map(_lodash2.default.trim).compact().value();
              } else {
                return arg;
              }
            });

            return function (_x7) {
              return _ref9.apply(this, arguments);
            };
          }());
          var featurePaths = _lodash2.default.flatten(nestedFeaturePaths);
          if (featurePaths.length > 0) {
            return featurePaths;
          }
        }
        return ['features/**/*.feature'];
      });

      function getUnexpandedFeaturePaths() {
        return _ref8.apply(this, arguments);
      }

      return getUnexpandedFeaturePaths;
    }()
  }]);
  return ConfigurationBuilder;
}();

exports.default = ConfigurationBuilder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY29uZmlndXJhdGlvbl9idWlsZGVyLmpzIl0sIm5hbWVzIjpbImdsb2JQIiwiQ29uZmlndXJhdGlvbkJ1aWxkZXIiLCJvcHRpb25zIiwiYnVpbGRlciIsImJ1aWxkIiwiYXJndiIsImN3ZCIsInBhcnNlZEFyZ3YiLCJwYXJzZSIsImFyZ3MiLCJsaXN0STE4bktleXdvcmRzRm9yIiwiaTE4bktleXdvcmRzIiwibGlzdEkxOG5MYW5ndWFnZXMiLCJpMThuTGFuZ3VhZ2VzIiwidW5leHBhbmRlZEZlYXR1cmVQYXRocyIsImdldFVuZXhwYW5kZWRGZWF0dXJlUGF0aHMiLCJmZWF0dXJlUGF0aHMiLCJzdXBwb3J0Q29kZVBhdGhzIiwiZXhwYW5kRmVhdHVyZVBhdGhzIiwidW5leHBhbmRlZFN1cHBvcnRDb2RlUGF0aHMiLCJyZXF1aXJlIiwibGVuZ3RoIiwiZ2V0RmVhdHVyZURpcmVjdG9yeVBhdGhzIiwiZXhwYW5kUGF0aHMiLCJmZWF0dXJlRGVmYXVsdExhbmd1YWdlIiwibGFuZ3VhZ2UiLCJmb3JtYXRzIiwiZ2V0Rm9ybWF0cyIsImZvcm1hdE9wdGlvbnMiLCJnZXRGb3JtYXRPcHRpb25zIiwicGFyYWxsZWwiLCJwcm9maWxlcyIsInByb2ZpbGUiLCJwaWNrbGVGaWx0ZXJPcHRpb25zIiwibmFtZXMiLCJuYW1lIiwidGFnRXhwcmVzc2lvbiIsInRhZ3MiLCJydW50aW1lT3B0aW9ucyIsImRyeVJ1biIsImZhaWxGYXN0IiwiZmlsdGVyU3RhY2t0cmFjZXMiLCJiYWNrdHJhY2UiLCJzdHJpY3QiLCJ3b3JsZFBhcmFtZXRlcnMiLCJzaG91bGRFeGl0SW1tZWRpYXRlbHkiLCJleGl0Iiwic3VwcG9ydENvZGVSZXF1aXJlZE1vZHVsZXMiLCJyZXF1aXJlTW9kdWxlIiwidW5leHBhbmRlZFBhdGhzIiwiZGVmYXVsdEV4dGVuc2lvbiIsImV4cGFuZGVkUGF0aHMiLCJtYXAiLCJ1bmV4cGFuZGVkUGF0aCIsIm1hdGNoZXMiLCJhYnNvbHV0ZSIsIm1hdGNoIiwiZXh0bmFtZSIsImZsYXR0ZW5EZXB0aCIsIm5vcm1hbGl6ZSIsIngiLCJwIiwicmVwbGFjZSIsImZlYXR1cmVEaXJzIiwiZmVhdHVyZURpciIsImRpcm5hbWUiLCJmZWF0dXJlUGF0aCIsImNoaWxkRGlyIiwicGFyZW50RGlyIiwiYmFzZW5hbWUiLCJyZWxhdGl2ZSIsInVuaXEiLCJjbG9uZSIsImRlZmF1bHRzIiwiY29sb3JzRW5hYmxlZCIsIm1hcHBpbmciLCJmb3JtYXQiLCJmb3JFYWNoIiwic3BsaXQiLCJ0eXBlIiwib3V0cHV0VG8iLCJuZXN0ZWRGZWF0dXJlUGF0aHMiLCJhcmciLCJmaWxlbmFtZSIsImZpbGVQYXRoIiwiam9pbiIsImNvbnRlbnQiLCJyZWFkRmlsZSIsImNoYWluIiwidHJpbSIsImNvbXBhY3QiLCJ2YWx1ZSIsImZsYXR0ZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7OztBQUVBLElBQU1BLFFBQVEsd0NBQWQ7O0lBRXFCQyxvQjs7OztxREFDQUMsTyxFQUFTO0FBQzFCLFlBQU1DLFVBQVUsSUFBSUYsb0JBQUosQ0FBeUJDLE9BQXpCLENBQWhCO0FBQ0EsZUFBTyxNQUFNQyxRQUFRQyxLQUFSLEVBQWI7QUFDRCxPOzs7Ozs7Ozs7O0FBRUQsdUNBQTJCO0FBQUEsUUFBYkMsSUFBYSxTQUFiQSxJQUFhO0FBQUEsUUFBUEMsR0FBTyxTQUFQQSxHQUFPO0FBQUE7O0FBQ3pCLFNBQUtBLEdBQUwsR0FBV0EsR0FBWDs7QUFFQSxRQUFNQyxhQUFhLHNCQUFXQyxLQUFYLENBQWlCSCxJQUFqQixDQUFuQjtBQUNBLFNBQUtJLElBQUwsR0FBWUYsV0FBV0UsSUFBdkI7QUFDQSxTQUFLUCxPQUFMLEdBQWVLLFdBQVdMLE9BQTFCO0FBQ0Q7Ozs7O3dEQUVhO0FBQ1osWUFBTVEsc0JBQXNCLEtBQUtSLE9BQUwsQ0FBYVMsWUFBekM7QUFDQSxZQUFNQyxvQkFBb0IsQ0FBQyxDQUFDLEtBQUtWLE9BQUwsQ0FBYVcsYUFBekM7QUFDQSxZQUFNQyx5QkFBeUIsTUFBTSxLQUFLQyx5QkFBTCxFQUFyQztBQUNBLFlBQUlDLGVBQWUsRUFBbkI7QUFDQSxZQUFJQyxtQkFBbUIsRUFBdkI7QUFDQSxZQUFJLENBQUNQLG1CQUFELElBQXdCLENBQUNFLGlCQUE3QixFQUFnRDtBQUM5Q0kseUJBQWUsTUFBTSxLQUFLRSxrQkFBTCxDQUF3Qkosc0JBQXhCLENBQXJCO0FBQ0EsY0FBSUssNkJBQTZCLEtBQUtqQixPQUFMLENBQWFrQixPQUE5QztBQUNBLGNBQUlELDJCQUEyQkUsTUFBM0IsS0FBc0MsQ0FBMUMsRUFBNkM7QUFDM0NGLHlDQUE2QixLQUFLRyx3QkFBTCxDQUE4Qk4sWUFBOUIsQ0FBN0I7QUFDRDtBQUNEQyw2QkFBbUIsTUFBTSxLQUFLTSxXQUFMLENBQ3ZCSiwwQkFEdUIsRUFFdkIsS0FGdUIsQ0FBekI7QUFJRDtBQUNELGVBQU87QUFDTEssa0NBQXdCLEtBQUt0QixPQUFMLENBQWF1QixRQURoQztBQUVMVCxvQ0FGSztBQUdMVSxtQkFBUyxLQUFLQyxVQUFMLEVBSEo7QUFJTEMseUJBQWUsS0FBS0MsZ0JBQUwsRUFKVjtBQUtMbkIsa0RBTEs7QUFNTEUsOENBTks7QUFPTGtCLG9CQUFVLEtBQUs1QixPQUFMLENBQWE0QixRQVBsQjtBQVFMQyxvQkFBVSxLQUFLN0IsT0FBTCxDQUFhOEIsT0FSbEI7QUFTTEMsK0JBQXFCO0FBQ25CakIsMEJBQWNGLHNCQURLO0FBRW5Cb0IsbUJBQU8sS0FBS2hDLE9BQUwsQ0FBYWlDLElBRkQ7QUFHbkJDLDJCQUFlLEtBQUtsQyxPQUFMLENBQWFtQztBQUhULFdBVGhCO0FBY0xDLDBCQUFnQjtBQUNkQyxvQkFBUSxDQUFDLENBQUMsS0FBS3JDLE9BQUwsQ0FBYXFDLE1BRFQ7QUFFZEMsc0JBQVUsQ0FBQyxDQUFDLEtBQUt0QyxPQUFMLENBQWFzQyxRQUZYO0FBR2RDLCtCQUFtQixDQUFDLEtBQUt2QyxPQUFMLENBQWF3QyxTQUhuQjtBQUlkQyxvQkFBUSxDQUFDLENBQUMsS0FBS3pDLE9BQUwsQ0FBYXlDLE1BSlQ7QUFLZEMsNkJBQWlCLEtBQUsxQyxPQUFMLENBQWEwQztBQUxoQixXQWRYO0FBcUJMQyxpQ0FBdUIsQ0FBQyxDQUFDLEtBQUszQyxPQUFMLENBQWE0QyxJQXJCakM7QUFzQkw3Qiw0Q0F0Qks7QUF1Qkw4QixzQ0FBNEIsS0FBSzdDLE9BQUwsQ0FBYThDO0FBdkJwQyxTQUFQO0FBeUJELE87Ozs7Ozs7Ozs7O3NEQUVpQkMsZSxFQUFpQkMsZ0IsRUFBa0I7QUFBQTs7QUFDbkQsWUFBTUMsZ0JBQWdCLE1BQU0sbUJBQVFDLEdBQVIsQ0FDMUJILGVBRDBCO0FBQUEsK0NBRTFCLFdBQU1JLGNBQU4sRUFBd0I7QUFDdEIsZ0JBQU1DLFVBQVUsTUFBTXRELE1BQU1xRCxjQUFOLEVBQXNCO0FBQzFDRSx3QkFBVSxJQURnQztBQUUxQ2pELG1CQUFLLE1BQUtBO0FBRmdDLGFBQXRCLENBQXRCO0FBSUEsbUJBQU8sTUFBTSxtQkFBUThDLEdBQVIsQ0FBWUUsT0FBWjtBQUFBLG1EQUFxQixXQUFNRSxLQUFOLEVBQWU7QUFDL0Msb0JBQUksZUFBS0MsT0FBTCxDQUFhRCxLQUFiLE1BQXdCLEVBQTVCLEVBQWdDO0FBQzlCLHlCQUFPLE1BQU14RCxNQUFTd0QsS0FBVCxhQUFzQk4sZ0JBQXRCLENBQWI7QUFDRDtBQUNELHVCQUFPTSxLQUFQO0FBQ0QsZUFMWTs7QUFBQTtBQUFBO0FBQUE7QUFBQSxnQkFBYjtBQU1ELFdBYnlCOztBQUFBO0FBQUE7QUFBQTtBQUFBLFlBQTVCO0FBZUEsZUFBTyxpQkFBRUUsWUFBRixDQUFlUCxhQUFmLEVBQThCLENBQTlCLEVBQWlDQyxHQUFqQyxDQUFxQztBQUFBLGlCQUFLLGVBQUtPLFNBQUwsQ0FBZUMsQ0FBZixDQUFMO0FBQUEsU0FBckMsQ0FBUDtBQUNELE87Ozs7Ozs7Ozs7O3NEQUV3QjVDLFksRUFBYztBQUNyQ0EsdUJBQWVBLGFBQWFvQyxHQUFiLENBQWlCO0FBQUEsaUJBQUtTLEVBQUVDLE9BQUYsQ0FBVSxXQUFWLEVBQXVCLEVBQXZCLENBQUw7QUFBQSxTQUFqQixDQUFmLENBRHFDLENBQzRCO0FBQ2pFLGVBQU8sTUFBTSxLQUFLdkMsV0FBTCxDQUFpQlAsWUFBakIsRUFBK0IsVUFBL0IsQ0FBYjtBQUNELE87Ozs7Ozs7Ozs7NkNBRXdCQSxZLEVBQWM7QUFBQTs7QUFDckMsVUFBTStDLGNBQWMvQyxhQUFhb0MsR0FBYixDQUFpQix1QkFBZTtBQUNsRCxZQUFJWSxhQUFhLGVBQUtDLE9BQUwsQ0FBYUMsV0FBYixDQUFqQjtBQUNBLFlBQUlDLGlCQUFKO0FBQ0EsWUFBSUMsWUFBWUosVUFBaEI7QUFDQSxlQUFPRyxhQUFhQyxTQUFwQixFQUErQjtBQUM3QkQscUJBQVdDLFNBQVg7QUFDQUEsc0JBQVksZUFBS0gsT0FBTCxDQUFhRSxRQUFiLENBQVo7QUFDQSxjQUFJLGVBQUtFLFFBQUwsQ0FBY0QsU0FBZCxNQUE2QixVQUFqQyxFQUE2QztBQUMzQ0oseUJBQWFJLFNBQWI7QUFDQTtBQUNEO0FBQ0Y7QUFDRCxlQUFPLGVBQUtFLFFBQUwsQ0FBYyxPQUFLaEUsR0FBbkIsRUFBd0IwRCxVQUF4QixDQUFQO0FBQ0QsT0FibUIsQ0FBcEI7QUFjQSxhQUFPLGlCQUFFTyxJQUFGLENBQU9SLFdBQVAsQ0FBUDtBQUNEOzs7dUNBRWtCO0FBQ2pCLFVBQU1uQyxnQkFBZ0IsaUJBQUU0QyxLQUFGLENBQVEsS0FBS3RFLE9BQUwsQ0FBYTBCLGFBQXJCLENBQXRCO0FBQ0FBLG9CQUFjdEIsR0FBZCxHQUFvQixLQUFLQSxHQUF6QjtBQUNBLHVCQUFFbUUsUUFBRixDQUFXN0MsYUFBWCxFQUEwQixFQUFFOEMsZUFBZSxJQUFqQixFQUExQjtBQUNBLGFBQU85QyxhQUFQO0FBQ0Q7OztpQ0FFWTtBQUNYLFVBQU0rQyxVQUFVLEVBQUUsSUFBSSxVQUFOLEVBQWhCO0FBQ0EsV0FBS3pFLE9BQUwsQ0FBYTBFLE1BQWIsQ0FBb0JDLE9BQXBCLENBQTRCLGtCQUFVO0FBQUEsb0NBQ1gsMEJBQWVDLEtBQWYsQ0FBcUJGLE1BQXJCLENBRFc7QUFBQTtBQUFBLFlBQzdCRyxJQUQ2QjtBQUFBLFlBQ3ZCQyxRQUR1Qjs7QUFFcENMLGdCQUFRSyxZQUFZLEVBQXBCLElBQTBCRCxJQUExQjtBQUNELE9BSEQ7QUFJQSxhQUFPLGlCQUFFM0IsR0FBRixDQUFNdUIsT0FBTixFQUFlLFVBQVNJLElBQVQsRUFBZUMsUUFBZixFQUF5QjtBQUM3QyxlQUFPLEVBQUVBLGtCQUFGLEVBQVlELFVBQVosRUFBUDtBQUNELE9BRk0sQ0FBUDtBQUdEOzs7O3dEQUVpQztBQUFBOztBQUNoQyxZQUFJLEtBQUt0RSxJQUFMLENBQVVZLE1BQVYsR0FBbUIsQ0FBdkIsRUFBMEI7QUFDeEIsY0FBTTRELHFCQUFxQixNQUFNLG1CQUFRN0IsR0FBUixDQUFZLEtBQUszQyxJQUFqQjtBQUFBLGlEQUF1QixXQUFNeUUsR0FBTixFQUFhO0FBQ25FLGtCQUFNQyxXQUFXLGVBQUtkLFFBQUwsQ0FBY2EsR0FBZCxDQUFqQjtBQUNBLGtCQUFJQyxTQUFTLENBQVQsTUFBZ0IsR0FBcEIsRUFBeUI7QUFDdkIsb0JBQU1DLFdBQVcsZUFBS0MsSUFBTCxDQUFVLE9BQUsvRSxHQUFmLEVBQW9CNEUsR0FBcEIsQ0FBakI7QUFDQSxvQkFBTUksVUFBVSxNQUFNLGFBQUdDLFFBQUgsQ0FBWUgsUUFBWixFQUFzQixNQUF0QixDQUF0QjtBQUNBLHVCQUFPLGlCQUFFSSxLQUFGLENBQVFGLE9BQVIsRUFDSlIsS0FESSxDQUNFLElBREYsRUFFSjFCLEdBRkksQ0FFQSxpQkFBRXFDLElBRkYsRUFHSkMsT0FISSxHQUlKQyxLQUpJLEVBQVA7QUFLRCxlQVJELE1BUU87QUFDTCx1QkFBT1QsR0FBUDtBQUNEO0FBQ0YsYUFiZ0M7O0FBQUE7QUFBQTtBQUFBO0FBQUEsY0FBakM7QUFjQSxjQUFNbEUsZUFBZSxpQkFBRTRFLE9BQUYsQ0FBVVgsa0JBQVYsQ0FBckI7QUFDQSxjQUFJakUsYUFBYUssTUFBYixHQUFzQixDQUExQixFQUE2QjtBQUMzQixtQkFBT0wsWUFBUDtBQUNEO0FBQ0Y7QUFDRCxlQUFPLENBQUMsdUJBQUQsQ0FBUDtBQUNELE87Ozs7Ozs7Ozs7OztrQkE1SWtCZixvQiIsImZpbGUiOiJjb25maWd1cmF0aW9uX2J1aWxkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnXG5pbXBvcnQgQXJndlBhcnNlciBmcm9tICcuL2FyZ3ZfcGFyc2VyJ1xuaW1wb3J0IGZzIGZyb20gJ216L2ZzJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBPcHRpb25TcGxpdHRlciBmcm9tICcuL29wdGlvbl9zcGxpdHRlcidcbmltcG9ydCBQcm9taXNlLCB7IHByb21pc2lmeSB9IGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IGdsb2IgZnJvbSAnZ2xvYidcblxuY29uc3QgZ2xvYlAgPSBwcm9taXNpZnkoZ2xvYilcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29uZmlndXJhdGlvbkJ1aWxkZXIge1xuICBzdGF0aWMgYXN5bmMgYnVpbGQob3B0aW9ucykge1xuICAgIGNvbnN0IGJ1aWxkZXIgPSBuZXcgQ29uZmlndXJhdGlvbkJ1aWxkZXIob3B0aW9ucylcbiAgICByZXR1cm4gYXdhaXQgYnVpbGRlci5idWlsZCgpXG4gIH1cblxuICBjb25zdHJ1Y3Rvcih7IGFyZ3YsIGN3ZCB9KSB7XG4gICAgdGhpcy5jd2QgPSBjd2RcblxuICAgIGNvbnN0IHBhcnNlZEFyZ3YgPSBBcmd2UGFyc2VyLnBhcnNlKGFyZ3YpXG4gICAgdGhpcy5hcmdzID0gcGFyc2VkQXJndi5hcmdzXG4gICAgdGhpcy5vcHRpb25zID0gcGFyc2VkQXJndi5vcHRpb25zXG4gIH1cblxuICBhc3luYyBidWlsZCgpIHtcbiAgICBjb25zdCBsaXN0STE4bktleXdvcmRzRm9yID0gdGhpcy5vcHRpb25zLmkxOG5LZXl3b3Jkc1xuICAgIGNvbnN0IGxpc3RJMThuTGFuZ3VhZ2VzID0gISF0aGlzLm9wdGlvbnMuaTE4bkxhbmd1YWdlc1xuICAgIGNvbnN0IHVuZXhwYW5kZWRGZWF0dXJlUGF0aHMgPSBhd2FpdCB0aGlzLmdldFVuZXhwYW5kZWRGZWF0dXJlUGF0aHMoKVxuICAgIGxldCBmZWF0dXJlUGF0aHMgPSBbXVxuICAgIGxldCBzdXBwb3J0Q29kZVBhdGhzID0gW11cbiAgICBpZiAoIWxpc3RJMThuS2V5d29yZHNGb3IgJiYgIWxpc3RJMThuTGFuZ3VhZ2VzKSB7XG4gICAgICBmZWF0dXJlUGF0aHMgPSBhd2FpdCB0aGlzLmV4cGFuZEZlYXR1cmVQYXRocyh1bmV4cGFuZGVkRmVhdHVyZVBhdGhzKVxuICAgICAgbGV0IHVuZXhwYW5kZWRTdXBwb3J0Q29kZVBhdGhzID0gdGhpcy5vcHRpb25zLnJlcXVpcmVcbiAgICAgIGlmICh1bmV4cGFuZGVkU3VwcG9ydENvZGVQYXRocy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdW5leHBhbmRlZFN1cHBvcnRDb2RlUGF0aHMgPSB0aGlzLmdldEZlYXR1cmVEaXJlY3RvcnlQYXRocyhmZWF0dXJlUGF0aHMpXG4gICAgICB9XG4gICAgICBzdXBwb3J0Q29kZVBhdGhzID0gYXdhaXQgdGhpcy5leHBhbmRQYXRocyhcbiAgICAgICAgdW5leHBhbmRlZFN1cHBvcnRDb2RlUGF0aHMsXG4gICAgICAgICcuanMnXG4gICAgICApXG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBmZWF0dXJlRGVmYXVsdExhbmd1YWdlOiB0aGlzLm9wdGlvbnMubGFuZ3VhZ2UsXG4gICAgICBmZWF0dXJlUGF0aHMsXG4gICAgICBmb3JtYXRzOiB0aGlzLmdldEZvcm1hdHMoKSxcbiAgICAgIGZvcm1hdE9wdGlvbnM6IHRoaXMuZ2V0Rm9ybWF0T3B0aW9ucygpLFxuICAgICAgbGlzdEkxOG5LZXl3b3Jkc0ZvcixcbiAgICAgIGxpc3RJMThuTGFuZ3VhZ2VzLFxuICAgICAgcGFyYWxsZWw6IHRoaXMub3B0aW9ucy5wYXJhbGxlbCxcbiAgICAgIHByb2ZpbGVzOiB0aGlzLm9wdGlvbnMucHJvZmlsZSxcbiAgICAgIHBpY2tsZUZpbHRlck9wdGlvbnM6IHtcbiAgICAgICAgZmVhdHVyZVBhdGhzOiB1bmV4cGFuZGVkRmVhdHVyZVBhdGhzLFxuICAgICAgICBuYW1lczogdGhpcy5vcHRpb25zLm5hbWUsXG4gICAgICAgIHRhZ0V4cHJlc3Npb246IHRoaXMub3B0aW9ucy50YWdzXG4gICAgICB9LFxuICAgICAgcnVudGltZU9wdGlvbnM6IHtcbiAgICAgICAgZHJ5UnVuOiAhIXRoaXMub3B0aW9ucy5kcnlSdW4sXG4gICAgICAgIGZhaWxGYXN0OiAhIXRoaXMub3B0aW9ucy5mYWlsRmFzdCxcbiAgICAgICAgZmlsdGVyU3RhY2t0cmFjZXM6ICF0aGlzLm9wdGlvbnMuYmFja3RyYWNlLFxuICAgICAgICBzdHJpY3Q6ICEhdGhpcy5vcHRpb25zLnN0cmljdCxcbiAgICAgICAgd29ybGRQYXJhbWV0ZXJzOiB0aGlzLm9wdGlvbnMud29ybGRQYXJhbWV0ZXJzXG4gICAgICB9LFxuICAgICAgc2hvdWxkRXhpdEltbWVkaWF0ZWx5OiAhIXRoaXMub3B0aW9ucy5leGl0LFxuICAgICAgc3VwcG9ydENvZGVQYXRocyxcbiAgICAgIHN1cHBvcnRDb2RlUmVxdWlyZWRNb2R1bGVzOiB0aGlzLm9wdGlvbnMucmVxdWlyZU1vZHVsZVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGV4cGFuZFBhdGhzKHVuZXhwYW5kZWRQYXRocywgZGVmYXVsdEV4dGVuc2lvbikge1xuICAgIGNvbnN0IGV4cGFuZGVkUGF0aHMgPSBhd2FpdCBQcm9taXNlLm1hcChcbiAgICAgIHVuZXhwYW5kZWRQYXRocyxcbiAgICAgIGFzeW5jIHVuZXhwYW5kZWRQYXRoID0+IHtcbiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IGF3YWl0IGdsb2JQKHVuZXhwYW5kZWRQYXRoLCB7XG4gICAgICAgICAgYWJzb2x1dGU6IHRydWUsXG4gICAgICAgICAgY3dkOiB0aGlzLmN3ZFxuICAgICAgICB9KVxuICAgICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5tYXAobWF0Y2hlcywgYXN5bmMgbWF0Y2ggPT4ge1xuICAgICAgICAgIGlmIChwYXRoLmV4dG5hbWUobWF0Y2gpID09PSAnJykge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGdsb2JQKGAke21hdGNofS8qKi8qJHtkZWZhdWx0RXh0ZW5zaW9ufWApXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBtYXRjaFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIClcbiAgICByZXR1cm4gXy5mbGF0dGVuRGVwdGgoZXhwYW5kZWRQYXRocywgMikubWFwKHggPT4gcGF0aC5ub3JtYWxpemUoeCkpXG4gIH1cblxuICBhc3luYyBleHBhbmRGZWF0dXJlUGF0aHMoZmVhdHVyZVBhdGhzKSB7XG4gICAgZmVhdHVyZVBhdGhzID0gZmVhdHVyZVBhdGhzLm1hcChwID0+IHAucmVwbGFjZSgvKDpcXGQrKSokL2csICcnKSkgLy8gU3RyaXAgbGluZSBudW1iZXJzXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhwYW5kUGF0aHMoZmVhdHVyZVBhdGhzLCAnLmZlYXR1cmUnKVxuICB9XG5cbiAgZ2V0RmVhdHVyZURpcmVjdG9yeVBhdGhzKGZlYXR1cmVQYXRocykge1xuICAgIGNvbnN0IGZlYXR1cmVEaXJzID0gZmVhdHVyZVBhdGhzLm1hcChmZWF0dXJlUGF0aCA9PiB7XG4gICAgICBsZXQgZmVhdHVyZURpciA9IHBhdGguZGlybmFtZShmZWF0dXJlUGF0aClcbiAgICAgIGxldCBjaGlsZERpclxuICAgICAgbGV0IHBhcmVudERpciA9IGZlYXR1cmVEaXJcbiAgICAgIHdoaWxlIChjaGlsZERpciAhPT0gcGFyZW50RGlyKSB7XG4gICAgICAgIGNoaWxkRGlyID0gcGFyZW50RGlyXG4gICAgICAgIHBhcmVudERpciA9IHBhdGguZGlybmFtZShjaGlsZERpcilcbiAgICAgICAgaWYgKHBhdGguYmFzZW5hbWUocGFyZW50RGlyKSA9PT0gJ2ZlYXR1cmVzJykge1xuICAgICAgICAgIGZlYXR1cmVEaXIgPSBwYXJlbnREaXJcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgZmVhdHVyZURpcilcbiAgICB9KVxuICAgIHJldHVybiBfLnVuaXEoZmVhdHVyZURpcnMpXG4gIH1cblxuICBnZXRGb3JtYXRPcHRpb25zKCkge1xuICAgIGNvbnN0IGZvcm1hdE9wdGlvbnMgPSBfLmNsb25lKHRoaXMub3B0aW9ucy5mb3JtYXRPcHRpb25zKVxuICAgIGZvcm1hdE9wdGlvbnMuY3dkID0gdGhpcy5jd2RcbiAgICBfLmRlZmF1bHRzKGZvcm1hdE9wdGlvbnMsIHsgY29sb3JzRW5hYmxlZDogdHJ1ZSB9KVxuICAgIHJldHVybiBmb3JtYXRPcHRpb25zXG4gIH1cblxuICBnZXRGb3JtYXRzKCkge1xuICAgIGNvbnN0IG1hcHBpbmcgPSB7ICcnOiAncHJvZ3Jlc3MnIH1cbiAgICB0aGlzLm9wdGlvbnMuZm9ybWF0LmZvckVhY2goZm9ybWF0ID0+IHtcbiAgICAgIGNvbnN0IFt0eXBlLCBvdXRwdXRUb10gPSBPcHRpb25TcGxpdHRlci5zcGxpdChmb3JtYXQpXG4gICAgICBtYXBwaW5nW291dHB1dFRvIHx8ICcnXSA9IHR5cGVcbiAgICB9KVxuICAgIHJldHVybiBfLm1hcChtYXBwaW5nLCBmdW5jdGlvbih0eXBlLCBvdXRwdXRUbykge1xuICAgICAgcmV0dXJuIHsgb3V0cHV0VG8sIHR5cGUgfVxuICAgIH0pXG4gIH1cblxuICBhc3luYyBnZXRVbmV4cGFuZGVkRmVhdHVyZVBhdGhzKCkge1xuICAgIGlmICh0aGlzLmFyZ3MubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgbmVzdGVkRmVhdHVyZVBhdGhzID0gYXdhaXQgUHJvbWlzZS5tYXAodGhpcy5hcmdzLCBhc3luYyBhcmcgPT4ge1xuICAgICAgICBjb25zdCBmaWxlbmFtZSA9IHBhdGguYmFzZW5hbWUoYXJnKVxuICAgICAgICBpZiAoZmlsZW5hbWVbMF0gPT09ICdAJykge1xuICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKHRoaXMuY3dkLCBhcmcpXG4gICAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVQYXRoLCAndXRmOCcpXG4gICAgICAgICAgcmV0dXJuIF8uY2hhaW4oY29udGVudClcbiAgICAgICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgICAgIC5tYXAoXy50cmltKVxuICAgICAgICAgICAgLmNvbXBhY3QoKVxuICAgICAgICAgICAgLnZhbHVlKClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gYXJnXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICBjb25zdCBmZWF0dXJlUGF0aHMgPSBfLmZsYXR0ZW4obmVzdGVkRmVhdHVyZVBhdGhzKVxuICAgICAgaWYgKGZlYXR1cmVQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiBmZWF0dXJlUGF0aHNcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFsnZmVhdHVyZXMvKiovKi5mZWF0dXJlJ11cbiAgfVxufVxuIl19